/*
*********************************************************************************************************
*                                      OPERATING SYSTEM PACKAGE
*
* Name    : 系统计时器
* Version : V1.0
* Author  : 空格键
* ----------------------------
* Note(s) : 使用T0定时器，1ms产生一个中断。使用无符号32位计时，最大可以可运行45.7天溢出。
* Tip(s)  : 如果要提高时间精度，或者增大运行天数，可使用结构体，{中断计数，计数溢出计数}
*********************************************************************************************************
*/

#include "os_timer.h"



/*
*********************************************************************************************************
*                                               DEFINE
*********************************************************************************************************
*/

#define T_1MS (65536-SYSclk/1000)   //1ms timer 重载值
#define T_1US_CNT (SYSclk/1000000)  //1us所属个数


volatile u32 data os_tick;  //系统计时器，无符号32位(4字节)
volatile bit data os_start_enable; //启动标识



/*
*********************************************************************************************************
*                                             INTERRUPT
*********************************************************************************************************
*/

/*T0中断服务程序*/
void T0_ISR() interrupt 1 using 1
{
    os_tick++;

    if (!os_start_enable)
        return;

    OS_TaskMark();
}

/*
*********************************************************************************************************
* Description : 系统计时器初始化
*
* Caller(s)   : -
*
* Note(s)     : none.
*********************************************************************************************************
*/
void OS_TIMER_Init(void)
{
    os_tick = 0ul;
    os_start_enable = 0;

    AUXR |= 0x80;   //定时器0为1T模式
    TMOD &= ~0x0F;  //定时器0模式0：16位自动重载
    TL0 = T_1MS;     
    TH0 = T_1MS >> 8;
    ET0 = 1;        //使能定时器中断
    EA = 1;         //开总中断
    
    TR0 = 1;        //启动定时器
}

/*
*********************************************************************************************************
* Description : 获取系统计时器微秒数
*
* Return(s)   : 返回计时器微秒部分，取值[0,999]
*
* Note(s)     : none.
*********************************************************************************************************
*/
u16 OS_TIMER_GetUs(void)
{
    u16 idata tmp1 = T_1MS, tmp2 = T_1US_CNT;
    return ((TH0 << 8 | TL0) - tmp1) / tmp2;
}

/**********************************************END******************************************************/
